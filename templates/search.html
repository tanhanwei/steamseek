{% extends "base.html" %}
{% block title %}Search Games{% endblock %}

{% block content %}
  <h1>Search Games</h1>
  <form method="post" action="{{ url_for('search') }}">
    <div class="mb-3">
      <input type="text" name="query" class="form-control" placeholder="Enter search keywords" value="{{ query }}">
    </div>
    <div class="row mb-3">
      <div class="col-md-3">
        <label for="genre">Genre:</label>
        <select name="genre" class="form-select">
          <option value="All" {% if selected_genre == "All" %}selected{% endif %}>All</option>
          <option value="Casual" {% if selected_genre == "Casual" %}selected{% endif %}>Casual</option>
          <option value="Indie" {% if selected_genre == "Indie" %}selected{% endif %}>Indie</option>
          <option value="Action" {% if selected_genre == "Action" %}selected{% endif %}>Action</option>
          <!-- Add more genres as needed -->
        </select>
      </div>
      <div class="col-md-3">
        <label for="release_year">Release Year:</label>
        <select name="release_year" class="form-select">
          <option value="All" {% if selected_year == "All" %}selected{% endif %}>All</option>
          <!-- Example options; extend as needed -->
          <option value="2024" {% if selected_year == "2024" %}selected{% endif %}>2024</option>
          <option value="2023" {% if selected_year == "2023" %}selected{% endif %}>2023</option>
          <option value="2022" {% if selected_year == "2022" %}selected{% endif %}>2022</option>
          <option value="2021" {% if selected_year == "2021" %}selected{% endif %}>2021</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="platform">Platform:</label>
        <select name="platform" class="form-select">
          <option value="All" {% if selected_platform == "All" %}selected{% endif %}>All</option>
          <option value="Windows" {% if selected_platform == "Windows" %}selected{% endif %}>Windows</option>
          <option value="Mac" {% if selected_platform == "Mac" %}selected{% endif %}>Mac</option>
          <option value="Linux" {% if selected_platform == "Linux" %}selected{% endif %}>Linux</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="price">Price:</label>
        <select name="price" class="form-select">
          <option value="All" {% if selected_price == "All" %}selected{% endif %}>All</option>
          <option value="Free" {% if selected_price == "Free" %}selected{% endif %}>Free</option>
          <option value="Paid" {% if selected_price == "Paid" %}selected{% endif %}>Paid</option>
        </select>
      </div>
    </div>
    <div class="mb-3">
      <label for="sort_by">Sort By:</label>
      <select name="sort_by" class="form-select">
        <option value="Relevance" {% if sort_by == "Relevance" %}selected{% endif %}>Relevance</option>
        <option value="Name (A-Z)" {% if sort_by == "Name (A-Z)" %}selected{% endif %}>Name (A-Z)</option>
        <option value="Release Date (Newest)" {% if sort_by == "Release Date (Newest)" %}selected{% endif %}>Release Date (Newest)</option>
        <option value="Release Date (Oldest)" {% if sort_by == "Release Date (Oldest)" %}selected{% endif %}>Release Date (Oldest)</option>
        <option value="Price (Low to High)" {% if sort_by == "Price (Low to High)" %}selected{% endif %}>Price (Low to High)</option>
        <option value="Price (High to Low)" {% if sort_by == "Price (High to Low)" %}selected{% endif %}>Price (High to Low)</option>
        <option value="Review Count (High to Low)" {% if sort_by == "Review Count (High to Low)" %}selected{% endif %}>Review Count (High to Low)</option>
        <option value="Positive Review % (High to Low)" {% if sort_by == "Positive Review % (High to Low)" %}selected{% endif %}>Positive Review % (High to Low)</option>
      </select>
    </div>
    <button type="submit" class="btn btn-primary">Search</button>
  </form>
  <hr>
  {% if results %}
    <div class="row">
      {% for r in results %}
        <div class="col-md-6 mb-3">
          <div class="card">
            <!-- Bootstrap Carousel for each result -->
            <div id="carousel-{{ r.appid }}" class="carousel slide">
              <div class="carousel-inner">
                {% for item in r.media %}
                  {% set lower_item = item|lower %}
                  <div class="carousel-item {% if loop.first %}active{% endif %}">
                    {% if 'webm' in lower_item %}
                      <video class="d-block w-100" controls>
                        <source src="{{ item }}" type="video/webm">
                        Your browser does not support the video tag.
                      </video>
                    {% elif 'mp4' in lower_item %}
                      <video class="d-block w-100" controls>
                        <source src="{{ item }}" type="video/mp4">
                        Your browser does not support the video tag.
                      </video>
                    {% else %}
                      <img src="{{ item }}" class="d-block w-100" alt="{{ r.name }}">
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
              {% if r.media|length > 1 %}
                <button class="carousel-control-prev" type="button" data-bs-target="#carousel-{{ r.appid }}" data-bs-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carousel-{{ r.appid }}" data-bs-slide="next">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Next</span>
                </button>
              {% endif %}
            </div>
            <div class="card-body">
              <h5 class="card-title">
                <a href="https://store.steampowered.com/app/{{ r.appid }}/" target="_blank" style="text-decoration: none; color: inherit;">
                  {{ r.name }}
                </a>
              </h5>
              <p class="card-text">
                {% if r.genres %}
                  <small>Genres: {{ r.genres|join(', ') }}</small><br>
                {% endif %}
                <small>Release Year: {{ r.release_year }}</small><br>
                <small>Price: {% if r.is_free %}Free{% else %}${{ r.price }}{% endif %}</small><br>
                <small>Positive: {{ r.pos_percent|round(0) }}%</small><br>
                <small>Reviews: {{ r.total_reviews }}</small>
              </p>
              {% if r.ai_summary %}
                <p>
                  <a class="btn btn-secondary" data-bs-toggle="collapse" href="#summary-{{ r.appid }}" role="button" aria-expanded="false" aria-controls="summary-{{ r.appid }}">
                    Show AI Summary
                  </a>
                </p>
                <div class="collapse" id="summary-{{ r.appid }}">
                  <div class="card card-body">
                    {{ r.ai_summary|markdown }}
                  </div>
                </div>
              {% endif %}
              <div class="d-flex gap-2">
                <a href="{{ url_for('detail', appid=r.appid, q=query) }}" class="btn btn-primary show-loader">Analyze</a>
                <a href="https://www.youtube.com/results?search_query={{ r.name|replace(' ', '+') }}+gameplay" target="_blank" class="btn btn-danger">YouTube</a>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>Type something in the box above to begin searching.</p>
  {% endif %}
{% endblock %}
